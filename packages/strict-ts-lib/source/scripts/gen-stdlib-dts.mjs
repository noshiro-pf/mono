import { toThisDir } from '@noshiro/mono-scripts/node-utils/path-utils.mjs';
import * as fs from 'node:fs/promises';
import * as nodePath from 'node:path';

const thisDir = toThisDir(import.meta.url);

const stdlibDir = nodePath.resolve(thisDir, '../dist');

const main = async () => {
  /**
   * ```js
   * [
   *   'lib.d.ts',
   *   'lib.dom.d.ts',
   *   'lib.dom.iterable.d.ts',
   *   ```
   * ]
   * ...
   */
  // eslint-disable-next-line security/detect-non-literal-fs-filename
  const stdlibFiles = await fs.readdir(stdlibDir);

  /** @type {readonly string[]} */
  const stdlibs = stdlibFiles
    .filter((f) => f !== 'utils.d.ts')
    .map((filename) => `/// <reference path="./dist/${filename}" />`);

  const result = [
    '/// <reference no-default-lib="true"/>',
    '',
    ...stdlibs,
    '',
    `// Created at: ${new Date().toISOString()}`,
    "// This file is generated by 'packages/strict-ts-lib/source/scripts/gen-stdlib-dts.mjs'",
  ].join('\n');

  // eslint-disable-next-line security/detect-non-literal-fs-filename
  await fs.writeFile(`${thisDir}/../stdlib.d.ts`, result);
};

main().catch(console.error);
